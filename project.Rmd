---
title: "Investigating the COVID-19 Outbreak"
author: 'Team 2!: Delaney Demark, Jenny Huang, Abby Mapes, Harshavardhan Srijay'
subtitle: ''
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, 
                      message = FALSE, warning = FALSE,
                      fig.height=6, fig.width = 9, fig.align = "center")
```

```{r load-packages}
library(tidyverse)
library(broom)
library(infer)
```

## Cleaning Data

```{r load-data}
covid <- read_csv("data/covid.csv")
```

```{r clean-data}
covid <- covid %>%
  mutate(reporting_date = `reporting date`, visiting_wuhan = `visiting Wuhan`, 
         from_wuhan = `from Wuhan`, 
         if_onset_approximated = If_onset_approximated)%>%
  select(id, reporting_date, location, country, gender, age, symptom_onset, if_onset_approximated, hosp_visit_date, exposure_start, exposure_end, 
         visiting_wuhan, from_wuhan, death, recovered, source)

covid <- covid %>%
  mutate(id = factor(id), if_onset_approximated = factor(if_onset_approximated), 
         visiting_wuhan = factor(visiting_wuhan), 
         from_wuhan = factor(from_wuhan), death = factor(death), recovered = factor(recovered))%>%
  mutate(reporting_date = as.Date(reporting_date, "%m/%d/%Y"), 
         symptom_onset = as.Date(symptom_onset, "%m/%d/%Y"), 
         hosp_visit_date = as.Date(hosp_visit_date, "%m/%d/%Y"), 
         exposure_start = as.Date(exposure_start, "%m/%d/%Y"), 
         exposure_end = as.Date(exposure_end, "%m/%d/%Y"),
         death = ifelse(death == 0, "No", "Yes"))
```

```{r add age group, echo = FALSE}
covid <- covid %>%
  mutate(age_group = ifelse(age < 20, "0-19", (ifelse(age <40, "20-39",
  ifelse(age < 60, "40-59", ifelse(age < 80, "60-79", "80-99"))))))%>%
  mutate(age_group = ifelse(is.na(age_group), "NA", age_group))
```

## Section 1: Introduction

Several recent reports suggest that older age groups show more severe symptoms 
in the face of COVID-19, causing the virus to be more deadly for older age 
groups. We want to test whether this is true by comparing the death rate of 
older individuals to the death rate of younger individuals. Our null 
hypothesis (H0 ) is that the death rate for older individuals is the same as 
the death rate for younger individuals, while our alternative hypothesis (H1) 
is that the death rate for older individuals is higher than that of younger 
individuals. 

We plan on working with the data from the early stages of the COVID-19 
outbreak from 1/20/2020 to 2/15/2020. This data set, from Kaggle, was first 
extracted from information provided by Johns Hopkins University. Johns 
Hopkins University collected this data from the World Health Organization, 
the Center for Disease Control and Prevention, the European Centre for Disease 
Prevention and Control, the National Health Commission of the People’s 
Republic of China, among other state and national government health 
departments. Each observation in the data set is a case in which an individual 
tested positive for COVID-19. The variables include the ID number of the 
individual, the number that the case is in the country, the date the case was 
reported, the location of the case, the gender of the individual, the age of 
the individual, the age group of the individual, the date of the onset of 
symptoms, the date of the hospital visit, the start and end dates of exposure 
to the virus, if the individual visited Wuhan, if the individual was from 
Wuhan, if the patient died, and if the patient recovered. 

Link to Data: https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-
dataset#COVID19_line_list_data.csv


## Section 2: Data Analysis Plan

Through our analysis, we will use death as our outcome variable by analyzing 
the proportion of patients who have died, indicated by a value of “yes” for 
death. To do so, we will use the following predictor variables: 
age_group, gender, visited_wuhan, from_wuhan, country. 

Using these variables, we will attempt to determine not only if age affects 
one’s survival outcome due to COVID-19, but also if any of these other 
characteristics are associated with one’s survival outcome. 

To start, we will preform some preliminary exploratory data analysis to learn 
more about our data.

First, we will determine the death rate, proportion of those dead, of all 
patients in our dataset. As we can see, there is a small percentage, about 6%, 
of patients who died from COVID-19 in our data set. 

```{r death-rate}
covid %>%
  mutate(death = ifelse(death == "No", "Alive", "Dead"))%>%
  count(death)%>% 
  mutate(prop_dead = n / sum(n))
```

Now, we will look at the survival rate by age group.

```{r death-rate-by-age}
covid %>%
  mutate(death = ifelse(death == "No", "Alive", "Dead")) %>%
  group_by(age_group) %>% 
  count(death)%>% 
  mutate(prop_dead = n / sum(n))
```
The death rate is lowest for the 20-39 age group
while highest for the 80-99 age group. Older age
groups, then, tend to have a higher death rate.

Now, we will visualize survival status faceted by age_group.

```{r survival-status-by-age, fig.height=5, fig.width=5}
covid %>%
  mutate(death = ifelse(death == "Yes", "Dead", "Alive")) %>%
  filter(age_group != "NA") %>% 
  ggplot(mapping = aes(x = death, fill = death)) + 
  geom_bar(stat = "count") +
  facet_wrap( ~ age_group, ncol = 3) +
  theme_bw() +
  labs(title = "Survival Status By Age", x = "Survival Status",
       y = "Number of Patients", fill = "Survival Status")
```

We will also visualize the ages of patients for each survival status.

```{r age-vs-survival-status, fig.height=5, fig.width=5}
covid %>%
  mutate(death = ifelse(death == "Yes", "Dead", "Alive"))%>%
  ggplot(mapping = aes(x = age, fill = death)) + 
  geom_histogram(binwidth = 10, color = "black") +
  facet_wrap( ~ death, ncol = 1) +
  theme_bw() +
  labs(title = "Age of Patient vs. Survival Status", x = "Age",
       y = "Number of Patients", fill = "Survival Status")
```

Below is a summary table of the mean age of patients who have died from COVID-19
and those that haven't, out of all patients in our data set that reported their 
ages. As we can see, the average age of patients that have died is greater than 
the average age of patients that are alive. These ages give us a reference 
point to determine what age will be considered "old" and what ages will be 
considered "young" for our exploratory data analysis.

```{r mean-age-summary-table}
covid %>%
  filter(!is.na(age)) %>%
  mutate(death = ifelse(death == "Yes", "Dead", "Alive"))%>%
  group_by(death)%>% 
  summarise(mean_age = mean(age))%>% 
  arrange(desc(mean_age))
```
To understand some of our other explanatory variables, we will calculate some 
statistics to get a sense of our data in terms of gender, country, and patients 
who have been to Wuhan recently. As we can see below, around 35% of patients 
are female, 48% of patients are male and 17% of patients are not classified. 
Noting that more male patients are included in our data set will be important 
and helpful when performing our exploratory data analysis.

```{r gender-distribution}
covid %>%
  count(gender)%>% 
  mutate(prop = n / sum(n))
```

Additionally, the patients in our data set come from 38 different countries.
```{r country-count}
covid %>%
  count(country)%>% 
  mutate(total_countries = nrow(.))%>%
  select(total_countries)%>%
  slice(1:1)
```

However, as we can see below, 8 countries in our dataset have at least 1 
reported death, with China having the most number of deaths by a significant
margin, as of the date of our dataset. It will be helpful to know that 
only 8 of the 38 total countries in our data set have reported deaths when we 
consider the explanatory variable 'country' in our exploratory data analysis.

```{r age-country-summary-table}
covid %>%
  count(country, death) %>% 
  group_by(country) %>% 
  mutate(prop_dead = n / sum(n)) %>%
  filter(death == "Yes")%>%
  mutate(people_dead = n)%>%
  select(country, people_dead, prop_dead)
```

Additionally, from the summary table below, we see the mean age of the patients 
who have died for each country where there are reported deaths. In China, the 
mean age is about 71. In Taiwan, the mean age is 65. In Hong Kong, the mean age 
is about 54. However, since there were less than ten recorded deaths in 
countries other than China, the use of country as a predictor may yield
misleading results, so we plan to group the categories into "China" and 
"Other Countries."

```{r age-per-country}
covid %>%
  filter(!is.na(age)) %>%
  group_by(country)%>% 
  filter(death == "Yes") %>%
  summarise(mean_death_age = mean(age))%>% 
  arrange(desc(mean_death_age))
```

From the table below, we see the majority of patients included in our 
data set are not from Wuhan, nor have they reported that they have previously 
visited Wuhan. Even though the majority of patients in our data set are not 
from or have been to Wuhan, it will be interesting to see if time in Wuhan is 
associated with one's survival outcome.

```{r wuhan-distribution}
covid %>%
  count(from_wuhan) %>% 
  mutate(prop = n / sum(n)) %>%
  select(from_wuhan, prop)

covid %>%
  count(visiting_wuhan) %>% 
  mutate(prop = n / sum(n)) %>%
  select(visiting_wuhan, prop)
```

We plan to use the following statistical methods to answer our 
research questions about whether age_group, gender, country, 
visited_wuhan, from_wuhan play a role in 
variable death rate:

a) Calculate the conditional probability of P(Death | Age) to determine if 
there are any confounding variables: gender, visited_wuhan, from_wuhan, country.
We will also keep in mind that the conclusions we draw about death rate may be 
confounded with variables that are not included in our dataset, 
such as smoking/drinking status, chronic disease status, BMI, etc.

b) Use estimation via bootstrap to create a confidence interval 
for the mean age of affected individuals:

For each age_group, we will take bootstrap samples, calculate the mean death 
rate, and obtain a 95% confidence interval for the mean death rate of that 
particular age group. If the confidence intervals for the mean death rates do 
not overlap, we can conclude that the mean death rate for the older age group 
is significantly different from the mean death rate of the younger age group. 

If there are any confoundingvariables, we will estimate the mean age 
of affected individuals faceted by the confounding variables.


```{r ci-young}
covid_young_age <- covid %>%
  filter(age_group == "20-39") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_young <- covid_young_age %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


boot_dist_young %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
```

We are 95% confident that the true mean death rate of the population age 20-39 
is between the range of (0.03668033 and 0.06598361).

```{r ci-old}
covid_old_age <- covid %>%
  filter(age_group == "80-99") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_old <- covid_old_age %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


boot_dist_old %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
```
We are 95% confident that the true mean death rate of the population 
age 80-99 is between the range of (0.04545455 and 0.1590909).

Since the two confidence intervals overlap, we cannot claim that there is
significant difference between the mean death rate of individuals in the 
80-99 age group with those in 20-39 age group. However, both the 
lower and upper end of the confidence interval for the older age group 
(0.04545455 and 0.1590909) is higher than the interval for the younger age 
group (0.03668033 and 0.06598361).

We will repeat this process by determining the role of other explanatory 
variables on death rate: gender, country, visited_wuhan, and from_wuhan.

c) To get more information than seeing whether the confidence intervals overlap, 
we will use simulation-based hypothesis testing to give the exact probability 
estimate (p-value) for the alternate hypothesis.

H0: µ(death rate of young age group) = µ(death rate of old age group)
H1: µ(death rate of young age group) < µ(death rate of old age group)

By using the bootstrap distribution, we will see where the elderly mean 
death rate lies on the null distribution for the young mean death rate. 

First, we estimate the mean death rate among the older age group through
using bootstrap estimation.

```{r null-dist-old}
old_bootstrap <- covid_old_age %>%
  specify(response = death_rate) %>%
  generate(reps = 15000, type = "bootstrap") %>%
  calculate(stat = "mean")

old_boot_mean <- old_bootstrap %>%
  summarise(mean = mean(stat)) %>% 
  pull()
old_boot_mean
```

Next, we create a null distribution for the mean death rate of the younger 
age group.

```{r null-dist-young}
young_null_dist <- covid_young_age %>%
  specify(response = death_rate) %>%
  generate(reps = 15000, type = "bootstrap") %>%
  calculate(stat = "mean")
```

By graphing the sample mean for the older age group on the null distribution 
of the younger age group, we see that the probability of observing a sample 
mean the same or greater than that of the estimated mean for the older age 
group is very low.

```{r graph-null-dist-young, fig.height = 5, fig.width = 6}
visualize(young_null_dist) +
  shade_p_value(obs_stat = old_boot_mean, direction = "greater") +
  theme_minimal(base_size = 16)
```

We confirm this by doing a hypothesis test and getting the p_value,
which comes out to be 6.666667e-05. Therefore, the probability of seeing a mean
death rate of 0.09094273 (the sample mean death rate of the older age group) 
for the younger age group is approximately zero.

```{r perform-hypothesis-test}
p_value <- covid_young_age %>%
  specify(response = death_rate) %>%
  generate(reps = 15000, type = "bootstrap") %>%
  calculate(stat = "mean") %>% 
  get_p_value(obs_stat = old_boot_mean, direction = "greater")
```

Thus, with an alpha level of 0.05, we have sufficient evidence to reject 
the null hypothesis that the mean death rate for the age group "80-99" is equal
to the mean death rate of age group "20-39." 

d) Next, we used a logistic regression model to obtain predicted probabilities
of an outcome of "death" given the explanatory variables in our model. 

The covid_class dataset is created below, selecting for the variables of 
interest (death, age, gender, visiting_wuhan, from_wuhan) and removing all "NA"
values.

```{r covid_class}
covid_class <- covid %>% 
  select(death, age, gender, visiting_wuhan, from_wuhan)

covid_class <- na.omit(covid_class, invert = FALSE)
```

We picked random observations to set aside as our testing data. 

```{r create-indices}
set.seed(03052020)
indices <- sample(nrow(covid_class), 100) # 100 observations to test on
```

We created training and testing datasets covid_train and covid_test. 

Also, a vector of the class labels for the training dataset, train_type, 
and a vector of the true class labels for the test dataset, true_type, were 
created.

```{r train-and-test-data}
covid_test <- covid_class  %>% 
  slice(indices) 

covid_train <- covid_class %>% 
  slice(-indices)

train_type <- covid_train %>% 
  pull(death)

true_type <- covid_test %>% 
  pull(death)
```

The R function glm() requires for logistic regression that the response variable 
takes on values of 0 or 1. Create a new variable in the training dataset named 
bin_type that is 0 if the patient did not die, and 1 if the patient died.

```{r ex_7}
covid_train_log <- covid_train %>% 
  mutate(bin_type = if_else(death == "Yes", 1, 0))
```


```{r logit-mod}
logit_mod <- glm(bin_type ~ gender + age + visiting_wuhan + from_wuhan, 
                 data = covid_train_log, family = "binomial")

tidy(logit_mod) %>%
  select(term,estimate)
```

Holding all other variables constant, for each unit increase in age, 
we would expect the log-odds of a covid-19 case resulting in deaths to increase 
by approximately 0.07870473.

As we can see below, the prediction accuracy is 90% for our logistic 
regression model.

```{r classifier}
pred_log_odds <- augment(logit_mod, newdata = covid_test) %>%
  pull(.fitted)

pred_probs <- exp(pred_log_odds) / (1 + exp(pred_log_odds))
pred_probs <- round(pred_probs,3)

for (i in 1:100){
  pred_probs[i]
}

classified_types <- character(75)

for (i in 1:100){
  classified_types[i] <- if_else(pred_probs[i] > .5, "Yes", "No")
}

pred_probs
classified_types
mean(classified_types == true_type)
```


## Section 3: Data
The dimensions of our dataset are 1,085 rows by 16 columns.
```{r glimpse-data}
glimpse(covid)
```

## Section 4: Methods and Results

## I. Conditional Probabilities
First, we will calculate the conditional probability of P(Death | Age) for 
each age group and determine if there are any confounding variables: 
gender, visited_wuhan, from_wuhan, country. Below, we calculate and visualize 
P(Dead|Age Group). From the visualization, we see that P(Dead|Age Group) 
increases as the age groups increase. For this part, we will filter out any 
patients with unrecorded ages in our data set, as we will not be able to take 
these into consideration with calculating P(Death | Age). 

```{r P(Dead|AgeGroup), fig.height=5, fig.width=5}
covid_condprob <- covid %>%
  filter(!is.na(age_group))%>%
  filter(!is.na(death))%>%
  filter(age_group != "NA")

covid_condprob %>%
  count(age_group, death)%>% 
  group_by(age_group)%>% 
  mutate(prop_dead = n / sum(n))%>%
  select(age_group, death, prop_dead)

ggplot(covid_condprob, mapping = aes(x = age_group, fill = death)) + 
  geom_bar(position = "fill") +
  labs(y = "", x = "Age Group", fill = "Dead", title =
         "Survival Outcome by Age Group")
```

Now, we will divide the observations in our data by gender, allowing us to 
consider gender as a possible explanation of our data. As seen in the 
calculation and visualization of P(Dead|Age Group) for each gender, just as 
we saw in the visualization above, P(Dead|Age Group) increases as the age 
groups increase for both men and women. Thus, gender doesn't seem to act as a
confounding variable that is correlated with both the explanatory and response 
variables.

```{r P(Dead|AgeGroup)_gender, fig.height=5, fig.width=5}
covid_condprob %>%
  filter(!is.na(gender))%>%
  count(gender, age_group, death)%>% 
  group_by(gender, age_group)%>% 
  mutate(prop_dead = n / sum(n))%>%
  select(age_group, death, gender, prop_dead)

covid_condprob %>%
  filter(!is.na(gender))%>%
ggplot(mapping = aes(x = age_group, fill = death)) + 
  geom_bar(position = "fill") +
  facet_wrap(.~ gender)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  labs(y = "", x = "Age Group", fill = "Dead", title =
         "Survival Outcome by Age Group by Gender")
```

Now, we will divide the patients in our dataset by whether or not the 
patient has visited Wuhan recently, allowing us to consider visiting Wuhan as a 
possible explanation of our data. As seen in the calculation and visualization 
of P(Dead|Age Group), P(Dead|Age Group) increases as the age groups increase for 
patients that have not visited Wuhan. For patients that haven't visited 
Wuhan, P(Dead|Age Group) is 0. However, as we saw in our exploratory data 
analysis (Section 2), only 18% of patients in our data set had indicated that 
they had visited Wuhan recently and the other 82% indicated that they had not. 
Of the 18% of patients who indicated that they had visited Wuhan recently, 
only 1 of them died. So, we don't have many data points to 
calculate P(Dead|Age Group) for patients that have visited Wuhan recently, so 
we can't determine whether visiting wuhan acts as a confounding variable 
that is correlated with both the explanatory and response variables.

```{r P(Dead|AgeGroup)_visited_wuhan, fig.height=5, fig.width=5}
covid_condprob %>%
  count(visiting_wuhan, age_group, death)%>% 
  group_by(visiting_wuhan, age_group)%>% 
  mutate(prop_dead = n / sum(n))%>%
  select(age_group, death, visiting_wuhan, prop_dead)

covid_condprob %>%
ggplot(mapping = aes(x = age_group, fill = death)) + 
  geom_bar(position = "fill") +
  facet_wrap(.~ visiting_wuhan)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  labs(y = "", x = "Age Group", fill = "Dead", title =
         "Survival Outcome by Visiting Wuhan")
```

Now, we will divide the patients in our dataset by whether or not the 
patient lives in Wuhan, allowing us to consider visiting Wuhan as a possible 
explanation of our data. As seen in the calculation and visualization of 
P(Dead|Age Group) below, P(Dead|Age Group) increases as the age groups increase 
for patients that live in Wuhan and patients that don't live in Wuhan. 
Interestingly, for patients that live in Wuhan, P(Dead|Age Group) is higher 
for all age groups over 40 years old than for patients that don't live in 
Wuhan. For 80-99 year old patients in our dataset, 100% of them who live in 
Wuhan have died, while only 17% of them who don't live in Wuhan have died. 
Keep in mind, the majority of patients in our data set are not from Wuhan and 
only 14% indicated that they lived in Wuhan. However, all 11 of the 80-99 year 
old patients from Wuhan died while only 5 of the 24 80-99 year old patients 
who were not from Wuhan died. 

```{r P(Dead|AgeGroup)_from_wuhan, fig.height=5, fig.width=5}
covid_condprob %>%
  filter(!is.na(from_wuhan))%>%
  count(from_wuhan, age_group, death)%>% 
  group_by(from_wuhan, age_group)%>% 
  mutate(prop_dead = n / sum(n))%>%
  select(age_group, death, from_wuhan, n, prop_dead)

covid_condprob %>%
  filter(!is.na(from_wuhan))%>%
ggplot(mapping = aes(x = age_group, fill = death)) + 
  geom_bar(position = "fill") +
  facet_wrap(.~ from_wuhan)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  labs(y = "", x = "Age Group", fill = "Dead", title =
         "Survival Outcome by Living in Wuhan")
```

Now, we will divide the patients in our data by country, allowing us to 
consider country of origin as a possible explanation of our data. We will only 
consider countries with recorded deaths in our data set. Note: we filtered 
any patients with unrecorded ages, these deaths are not included. As seen in 
the calculation and visualization of P(Dead|Age Group) for each country below, 
P(Dead|Age) for each country group never decreases as age increeases. However, 
we do not have enough data for each country to properly visualze P(Dead|Age) 
for each country and consider country of origin as a possible explanation of 
our data. 

```{r P(Dead|AgeGroup)_country, fig.height=5, fig.width=5}
countries_w_deaths <- covid %>%
  count(country, death) %>% 
  group_by(country) %>% 
  filter(death == "Yes")%>%
  pull(country)

covid_condprob %>%
  filter(country == countries_w_deaths)%>%
  count(country, age_group, death)%>% 
  group_by(country, age_group)%>% 
  mutate(prop_dead = n / sum(n))%>%
  select(age_group, death, country, prop_dead)

covid_condprob %>%
  filter(country == countries_w_deaths)%>%
ggplot(mapping = aes(x = age_group, fill = death)) + 
  geom_bar(position = "fill") +
  facet_wrap(.~ country)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  labs(y = "", x = "Age Group", fill = "Dead", title =
         "Survival Outcome by Country 
with Recorded Deaths")
```

Ulitmately, a patient's gender, whether they visited Wuhan recently, and what country they are from doesn't seem to affect the 
association between a patient's age group and their survival status from 
COVID-19.

## II. Mean Age of Affected Individuals

Now, we will create a 95% confidence interval for the population mean age of 
individuals infected with COVID-19, the population mean age of those infected 
with COVID-19 who survive, and the population mean age of those infected with
COVID-19 who die. To do so, we must assume that our sample is representative 
of the population. Additionally, in all three cases, there are more than 
5 observations in our original sample, since our data includes 1085 total 
infected patients, 1022 alive patients, and 63 dead patients, so, our original 
sample is greater than 5 for all cases, so it is not too small. Since our 
original sample is not too small and is representative of the population, 
we can create a bootstrap confidence interval.

First, we will create a 95% confidence interval for the population mean age of 
individuals infected with COVID-19. As seen below, we are 95% confident that 
the actual population mean age of infected individuals is between 
48.30 and	50.73.

```{r age_conf_int_total, fig.height=5, fig.width=5}
age_boot_dist <- covid %>%
  #filter(death == "No") %>%
  specify(response = age) %>%
  generate(reps = 5000, type = "bootstrap") %>%
  calculate(stat = "mean")
  
 
percentile_ci <- age_boot_dist %>% 
  summarize(lower_bound = quantile(stat, 0.025),
           upper_bound = quantile(stat, 0.975))

percentile_ci

visualize(age_boot_dist) +
 shade_confidence_interval(endpoints = percentile_ci) +
 labs(title = "Bootstrap distribution of Mean Age 
      of Infected Patients",
      x = "Mean", y = "Count",
      caption = "Green lines represent 95% C.I. bounds") +
 theme_minimal(base_size = 16)
```

Now, we will create a 95% confidence interval for the population mean age of 
individuals infected with COVID-19 who survive. As seen below, we are 95% 
confident that the actual population mean age of infected individuals who 
survive COVID-19 is between 46.82 and 49.30.	


```{r age_conf_int_alive, fig.height=5, fig.width=5}
age_boot_dist_alive <- covid %>%
  filter(death == "No") %>%
  specify(response = age) %>%
  generate(reps = 5000, type = "bootstrap") %>%
  calculate(stat = "mean")
  
 
percentile_ci_alive <- age_boot_dist_alive %>% 
  summarize(lower_bound = quantile(stat, 0.025),
           upper_bound = quantile(stat, 0.975))

percentile_ci_alive

visualize(age_boot_dist_alive) +
 shade_confidence_interval(endpoints = percentile_ci_alive, color = "blue",
                           fill = "blue") +
 labs(title = "Bootstrap distribution of Mean Age 
of Infected Patients who Survive",
      x = "Mean", y = "Count",
      caption = "Blue lines represent 95% C.I. bounds") +
 theme_minimal(base_size = 16)
```

Now, we will create a 95% confidence interval for the population mean age of 
individuals infected with COVID-19 who die. As seen below, we are 95% 
confident that the actual population mean age of infected individuals who 
die from COVID-19 is between 65.13 and 71.98.		

```{r age_conf_int_dead, fig.height=5, fig.width=5}
age_boot_dist_dead <- covid %>%
  filter(death == "Yes") %>%
  specify(response = age) %>%
  generate(reps = 5000, type = "bootstrap") %>%
  calculate(stat = "mean")
  
 
percentile_ci_dead <- age_boot_dist_dead %>% 
  summarize(lower_bound = quantile(stat, 0.025),
           upper_bound = quantile(stat, 0.975))

percentile_ci_dead

visualize(age_boot_dist_dead) +
 shade_confidence_interval(endpoints = percentile_ci_dead, color = "red",
                           fill = "red") +
 labs(title = "Bootstrap distribution of Mean Age 
of Infected Patients who Die",
      x = "Mean", y = "Count",
      caption = "Red lines represent 95% C.I. bounds") +
 theme_minimal(base_size = 16)
```

From the three 95% confidence intervals calculated above, we observe that the 
95% confidence interval for the true mean age of infected individuals who 
survive is the lowest, overlapping a year with the 95% confidence interval for 
the true mean age of all infected individuals. The 95% confidence interval for 
the true mean age of infected individuals who die is about 15 years higher than 
the other two intervals. 

## III. Association between Age Group and Death Rate

To further our study of whether death rate can be attributed to variables such
as the person's gender and whether the person is from Wuhan, beyond that of 
confidence intervals, we will conduct simulation-based two-sided hypothesis 
tests, under the $\alpha = 0.05$ level. 

When testing the effect of gender, we will calculate the difference in the
proportion of deaths between men and women in our sample. Our null hypothesis
is that there is no difference in the proportions of deaths between genders:
$$H_0: p_{male} = p_{female}$$
Our alternative hypothesis is that the proportion of deaths between the two
genders is not equal:
$$ H_A: p_{male} \neq p_{female}$$
```{r gender hypothesis test}
set.seed(1)
diff_props <- covid %>%
  specify(death ~ gender, success = "Yes") %>%
  calculate(stat = "diff in props", order = c("male", "female"))
null_dist_prop <- covid %>% 
   specify(death ~ gender, success = "Yes") %>%
   hypothesize(null = "independence") %>% 
   generate(reps = 1000, type = "permute") %>% 
   calculate(stat = "diff in props", order = c("male", "female"))
null_dist_prop %>% 
   get_p_value(obs_stat = diff_props, direction = "two_sided")
  
```

Here, our p-value was calculated as 0.06. This is higher than our 
aforementioned $\alpha$ level of 0.05, meaning that we do not have enough
evidence to suggest that the difference in proportion of deaths between
men and women is significantly different. This confirms our findings using
confidence intervals.

Similarly, we conducted simulation-based hypothesis tests for whether a person
is from Wuhan, using the following hypotheses:
$$H_0: p_{from Wuhan} = p_{not from Wuhan}$$
$$H_A: p_{from Wuhan} \neq p_{not from Wuhan}$$

```{r wuhan hypothesis test}
diff_props <- covid %>%
  specify(death ~ from_wuhan, success = "Yes") %>%
  calculate(stat = "diff in props", order = c("1", "0"))
null_dist_prop <- covid %>% 
   specify(death ~ from_wuhan, success = "Yes") %>%
   hypothesize(null = "independence") %>% 
   generate(reps = 1000, type = "permute") %>% 
   calculate(stat = "diff in props", order = c("1", "0"))
null_dist_prop %>% 
   get_p_value(obs_stat = diff_props, direction = "two_sided")
```

Here, our p-value was 0, meaning that we have enough evidence to reject our
null hypothesis. This means that there is a significant difference in proportion
of deaths between people from Wuhan and people not from Wuhan. This confirms
our findings using confidence intervals.

## IV. Logistic Modeling to Classify Death
Next, we used a logistic regression model to obtain predicted probabilities
of an outcome of "death" given the explanatory variables in our model. 

The covid_class dataset is created below, selecting for the variables of 
interest (death, age, gender, visiting_wuhan, from_wuhan) and removing all "NA"
values.

```{r covid_class}
covid_class <- covid %>% 
  select(death, age, gender, visiting_wuhan, from_wuhan)

covid_class <- na.omit(covid_class, invert = FALSE)
```

We picked random observations to set aside as our testing data. 

```{r create-indices}
set.seed(03052020)
indices <- sample(nrow(covid_class), 100) # 100 observations to test on
```

We created training and testing datasets covid_train and covid_test. 

Also, a vector of the class labels for the training dataset, train_type, 
and a vector of the true class labels for the test dataset, true_type, were 
created.

```{r train-and-test-data}
covid_test <- covid_class  %>% 
  slice(indices) 

covid_train <- covid_class %>% 
  slice(-indices)

train_type <- covid_train %>% 
  pull(death)

true_type <- covid_test %>% 
  pull(death)
```

The R function glm() requires for logistic regression that the response variable 
takes on values of 0 or 1. Create a new variable in the training dataset named 
bin_type that is 0 if the patient did not die, and 1 if the patient died.

```{r ex_7}
covid_train_log <- covid_train %>% 
  mutate(bin_type = if_else(death == "Yes", 1, 0))
```

Below is our logistic regression model to 

```{r logit-mod}
logit_mod <- glm(bin_type ~ gender + age + visiting_wuhan + from_wuhan, 
                 data = covid_train_log, family = "binomial")

tidy(logit_mod) %>%
  select(term,estimate)
```

Holding all other variables constant, for each unit increase in age, 
we would expect the log-odds of a covid-19 case resulting in deaths to increase 
by approximately 0.07870473.

Here we created a classifer with the cut-off value of 0.5.

```{r classifier}
pred_log_odds <- augment(logit_mod, newdata = covid_test) %>%
  pull(.fitted)

pred_probs <- exp(pred_log_odds) / (1 + exp(pred_log_odds))
pred_probs <- round(pred_probs,3)

for (i in 1:100){
  pred_probs[i]
}

classified_types <- character(75)

for (i in 1:100){
  classified_types[i] <- if_else(pred_probs[i] > .5, "Yes", "No")
}

pred_probs
classified_types

tibble(pred_probs, classified_types)
mean(classified_types == true_type)
```

As we can see above, the prediction accuracy is 90% for our logistic 
regression model.

## V. Confidence Intervals for Each Age Group
Now, for each age group, we will take bootstrap samples, calculate the mean 
death rate, and obtain a 95% confidence interval for the true mean death rate 
of that particular age group to see if the mean death rates overlap for each 
age group. To do so, we must assume that our sample is representative 
of the population. Additionally, in all age groups, there are more than 
5 observations from our original sample, so, our original sample 
for each confidence interval is greater than 5 for all cases, so it is not 
too small. Since our original sample is not too small and is representative 
of the population, we can create a bootstrap confidence interval.

First, we will create a 95% confidence interval for population mean death rate 
of individuals between 0 and 19 who are infected with COVID-19. As seen below, 
we are 95% confident that the actual population mean death rate of infected 
individuals between 0 and 19 is between 0.06 and 0.09.

```{r ci-youngest}
covid_youngst <- covid %>%
  filter(age_group == "0-19") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_youngst <- covid_youngst %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


int_0 <- boot_dist_youngst %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
int_0
```

Now, we will create a 95% confidence interval for population mean death rate 
of individuals between 20 and 39 who are infected with COVID-19. As seen below, 
we are 95% confident that the actual population mean death rate of infected 
individuals between 20 and 39 is between 0.04 and 0.07.

```{r ci-young-age}
covid_young_age <- covid %>%
  filter(age_group == "20-39") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_young <- covid_young_age %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


int_20 <- boot_dist_young %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
int_20
```

Now, we will create a 95% confidence interval for population mean death rate 
of individuals between 40 and 59 who are infected with COVID-19. As seen below, 
we are 95% confident that the actual population mean death rate of infected 
individuals between 40 and 59 is between 0.03 and 0.07.

```{r ci-middle-1}
covid_mid_1 <- covid %>%
  filter(age_group == "40-59") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_mid1 <- covid_mid_1 %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


int_40 <- boot_dist_mid1 %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
int_40
```

Now, we will create a 95% confidence interval for population mean death rate 
of individuals between 60 and 79 who are infected with COVID-19. As seen below, 
we are 95% confident that the actual population mean death rate of infected 
individuals between 60 and 79 is between 0.03 and 0.08.

```{r ci-middle-2}
covid_mid_2 <- covid %>%
  filter(age_group == "60-79") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_mid2 <- covid_mid_2 %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


int_60 <- boot_dist_mid2 %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
int_60
```

Finally, we will create a 95% confidence interval for population mean death 
rate of individuals between 80 and 99 who are infected with COVID-19. 
As seen below, we are 95% confident that the actual population mean death 
rate of infected individuals between 80 and 99 is between 0.05 and 0.16.

```{r ci-old-age}
covid_old_age <- covid %>%
  filter(age_group == "80-99") %>%
  count(age) %>% 
  mutate(death_rate = n / sum(n))

boot_dist_old <- covid_old_age %>%
  specify(response = death_rate) %>% 
  generate(reps = 15000, type = "bootstrap") %>% 
  calculate(stat = "mean")


int_old <- boot_dist_old %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))

int_old
```

The confidence intervals all seem to overlap, so we cannot claim that there 
is significant difference between the mean death rate of individuals in the 
different age groups. However, the upper end of the confidence interval for 
the oldest age group, 80 to 99 year old patients, is at least .07 higher 
than the upper end of the confidence intervals for any other age group. 

## Section 5: Discussion


- II: mean age CI
    interval for those infected is closer to interval to those that survive
    isn't the case that just older people are infected, those that are infected 
    usually survive but of those infected the ones who are older are the ones 
    that die (?)